-- Create the composite database
CREATE DATABASE IF NOT EXISTS composite_db;

-- Use the composite database
USE composite_db;

-- Create thread_comment_counts table for caching comment counts
CREATE TABLE IF NOT EXISTS thread_comment_counts (
    thread_id INT PRIMARY KEY,
    comment_count INT DEFAULT 0,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_last_updated (last_updated)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Create a table to track service health
CREATE TABLE IF NOT EXISTS service_health (
    service_name VARCHAR(50) PRIMARY KEY,
    last_checked TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_healthy BOOLEAN DEFAULT TRUE,
    error_message TEXT,
    INDEX idx_last_checked (last_checked)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Insert initial service health records
INSERT INTO service_health (service_name) VALUES 
    ('thread_service'),
    ('comment_service'),
    ('chapter_service'),
    ('user_service')
ON DUPLICATE KEY UPDATE last_checked = CURRENT_TIMESTAMP; 