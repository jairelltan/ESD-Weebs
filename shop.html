<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comic Book Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* Original comic collection styles */
        .comic-card {
            transition: transform 0.2s;
            height: 100%;
        }
        .comic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .genre-badge {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .comic-image-container {
            width: 100%;
            aspect-ratio: 1/1; /* Creates a perfect square */
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            max-width: 300px; /* Limit maximum size */
            margin-left: auto;
            margin-right: auto;
        }
        .comic-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center top;
        }
        .image-placeholder {
            width: 100%;
            aspect-ratio: 1/1; /* Creates a perfect square */
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            border-radius: 4px;
            max-width: 300px; /* Limit maximum size */
            margin-left: auto;
            margin-right: auto;
        }
        .btn-read {
            width: 100%;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 1rem;
        }

        /* Shop styles */
        .product-image {
            width: 100%;
            height: 250px;
            object-fit: contain;
        }
        .loading-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 9999;
        }
        .cart-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 30px;
            color: #000;
            z-index: 1000;
            cursor: pointer;
        }
        .modal-body {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Added styles for integration */
        .tab-content {
            padding-top: 20px;
        }
        .nav-tabs {
            margin-bottom: 0;
        }
        .tab-pane {
            background-color: #f8f9fa;
            border-radius: 0 0 5px 5px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-top: none;
        }
        .sticky-top {
            top: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Cart icon (from shop) -->
        <div class="cart-icon" @click="toggleCartModal" v-if="activeTab === 'shop'">
            <i class="bi bi-cart-fill"></i>
            <span class="badge bg-danger" v-if="cartItems.length > 0">{{ cartItems.length }}</span>
        </div>

        <!-- Loading Screen (from shop) -->
        <div v-if="loading" class="loading-screen">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Navigation Tabs (New) -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="#">Comic Book Hub</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" :class="{ active: activeTab === 'comics' }" href="#" 
                               @click.prevent="activeTab = 'comics'">Comics</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" :class="{ active: activeTab === 'shop' }" href="#" 
                               @click.prevent="activeTab = 'shop'">Shop</a>
                        </li>
                    </ul>
                </div>
                <div class="text-light" v-if="users.name">
                    <span>{{ users.name }} | </span>
                    <span>Points: {{ users.points }}</span>
                </div>
            </div>
        </nav>

        <!-- Tab Content (New) -->
        <div class="tab-content">
            <!-- Comics Tab -->
            <div class="tab-pane" :class="{ 'show active': activeTab === 'comics' }">
                <div class="container mt-4">
                    <h2 class="mb-4">Available Comics</h2>
                    <div class="row" id="comics-container">
                        <!-- Error handling -->
                        <div v-if="comicError" class="col-12 text-center">
                            <div class="alert alert-danger" role="alert">
                                Error loading comics. Please make sure the comic service is running on port 5001.
                                <br>
                                Error details: {{ comicError }}
                                <br>
                                <small>Check the browser console (F12) for more details.</small>
                            </div>
                        </div>

                        <!-- No comics found message -->
                        <div v-else-if="comics.length === 0 && !comicLoading" class="col-12 text-center">
                            <div class="alert alert-info" role="alert">
                                No comics found in the database.
                            </div>
                        </div>

                        <!-- Loading message -->
                        <div v-else-if="comicLoading" class="col-12 text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>

                        <!-- Comic cards -->
                        <div v-else v-for="comic in comics" :key="comic.comic_id" class="col-md-4 mb-4">
                            <div class="card comic-card">
                                <div class="card-body">
                                    <span class="badge status-badge" :class="getStatusBadgeClass(comic.status)">
                                        {{ comic.status }}
                                    </span>
                                    <h5 class="card-title">{{ comic.comic_name }}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted">By {{ comic.author }}</h6>
                                    
                                    <div v-if="comic.comic_art" class="comic-image-container">
                                        <img 
                                            :src="`data:image/webp;base64,${comic.comic_art}`" 
                                            class="comic-image" 
                                            :alt="comic.comic_name"
                                            @error="handleImageError($event)"
                                        >
                                    </div>
                                    <div v-else class="image-placeholder">
                                        <span>No image available</span>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <span 
                                            v-for="(genre, index) in comic.genre" 
                                            :key="index"
                                            class="badge bg-secondary genre-badge"
                                        >
                                            {{ genre }}
                                        </span>
                                    </div>
                                    <p class="card-text">{{ comic.description }}</p>
                                    
                                    <div class="action-buttons">
                                        <button class="btn btn-primary" @click="readComic(comic.comic_id)">
                                            <i class="bi bi-book"></i> Read
                                        </button>
                                        <button class="btn btn-success" @click="activeTab = 'shop'">
                                            <i class="bi bi-cart-plus"></i> Shop
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shop Tab -->
            <div class="tab-pane" :class="{ 'show active': activeTab === 'shop' }">
                <!-- Welcome Section -->
                <div class="container mt-3">
                    <div class="bg-light p-5 rounded text-center">
                        <h1 class="display-4">Welcome to the Shop!</h1>
                        <p class="lead">Buy books to support your favourite comic book creators.</p>
                        <hr class="my-4">
                        <p>If the book is out of stock, try out the preorder function!</p>
                    </div>
                </div>

                <!-- Products Section -->
                <div class="container mt-5" v-if="!loading">
                    <div class="row">
                        <div class="col-md-4" v-for="product in products" :key="product.Id">
                            <div class="card mb-4" @click="selectProduct(product)">
                                <img :src="`data:image/jpeg;base64,${product.image}`" class="card-img-top product-image"
                                    alt="Product Image">
                                <div class="card-body">
                                    <h5 class="card-title">{{ product.comic_name }} - Volume {{ product.volume_name }}</h5>
                                    <p class="card-text">Price: ${{ product.price_per_item.toFixed(2) }}</p>
                                    <p class="card-text">Stock: {{ product.quantity_in_stock }} available</p>

                                    <!-- Button Text based on stock availability -->
                                    <button class="btn btn-primary"
                                        @click="product.quantity_in_stock > 0 ? addToCart(product) : addToWaitlist(product)">
                                        {{ product.quantity_in_stock > 0 ? 'Purchase' : 'Join Waitlist' }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stock Update Form (For Demo Purposes)-->
                <div class="container mt-5">
                    <h2 v-if="selectedProduct">Update Stock for {{ selectedProduct.comic_name }} - Volume {{
                        selectedProduct.volume_name }}</h2>
                    <form @submit.prevent="updateStock">
                        <div class="mb-3">
                            <label for="stock" class="form-label">New Stock Quantity</label>
                            <input type="number" id="stock" class="form-control" v-model="newStock" min="0" required>
                        </div>
                        <button type="submit" class="btn btn-success" :disabled="selectedProduct === null">Update Stock</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Cart Modal (New) -->
        <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="cartModalLabel">Your Cart</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="cartItems.length === 0" class="text-center p-3">
                            Your cart is empty
                        </div>
                        <div v-else>
                            <div v-for="(item, index) in cartItems" :key="index" class="d-flex align-items-center mb-3 p-2 border-bottom">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{{ item.comic_name }} - Volume {{ item.volume_name }}</h6>
                                    <small class="text-muted">Price: ${{ item.price_per_item.toFixed(2) }}</small>
                                </div>
                                <button class="btn btn-sm btn-danger" @click="removeFromCart(index)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <h6>Total: ${{ cartTotal.toFixed(2) }}</h6>
                                <button class="btn btn-success" @click="checkout">Checkout</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    // Shared data
                    loading: true,
                    users: {},
                    activeTab: 'comics',
                    
                    // Comic collection data
                    comics: [],
                    comicLoading: true,
                    comicError: null,
                    
                    // Shop data
                    products: [],
                    selectedProduct: null,
                    newStock: 0,
                    cartItems: [],
                    cartModal: null
                };
            },
            computed: {
                cartTotal() {
                    return this.cartItems.reduce((total, item) => total + item.price_per_item, 0);
                }
            },
            mounted() {
                // Initialize the cart modal
                this.cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
                
                // Fetch user data
                this.fetchUserData();
                
                // Fetch comics data
                this.fetchComics();
                
                // Fetch shop products data
                this.fetchProducts();
            },
            methods: {
                // Shared methods
                fetchUserData() {
                    fetch('http://localhost:5000/user/1')
                        .then(response => response.json())
                        .then(data => {
                            if (data) {
                                this.users = {
                                    id: data.id,
                                    name: data.name,
                                    phone: data.phone,
                                    email: data.email,
                                    address: data.address,
                                    points: data.points,
                                    status: data.status
                                };
                            } else {
                                console.error('No data returned for the user with ID 1');
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching user data:', error);
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                },
                
                // Comic collection methods
                fetchComics() {
                    this.comicLoading = true;
                    console.log('Attempting to fetch comics from http://localhost:5001/comic');
                    fetch('http://localhost:5001/comic')
                        .then(response => {
                            console.log('Response status:', response.status);
                            if (!response.ok) {
                                return response.text().then(text => {
                                    throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            this.comics = data;
                            console.log('Received comics:', this.comics);
                        })
                        .catch(error => {
                            console.error('Error fetching comics:', error);
                            this.comicError = error.message;
                        })
                        .finally(() => {
                            this.comicLoading = false;
                        });
                },
                readComic(comicId) {
                    console.log(`Reading comic with ID: ${comicId}`);
                    window.location.href = `chapters.html?comic_id=${comicId}`;
                },
                getStatusBadgeClass(status) {
                    switch(status.toLowerCase()) {
                        case 'ongoing':
                            return 'bg-success';
                        case 'completed':
                            return 'bg-primary';
                        case 'hiatus':
                            return 'bg-warning';
                        default:
                            return 'bg-secondary';
                    }
                },
                handleImageError(event) {
                    console.error('Error loading image');
                    event.target.src = 'images/placeholder.webp';
                },
                
                // Shop methods
                fetchProducts() {
                    fetch('https://personal-dwnxuxog.outsystemscloud.com/InventoryAtomicMicroservice/rest/RESTAPI/GetAllProducts')
                        .then(response => response.json())
                        .then(data => {
                            this.products = data.Products;
                        })
                        .catch(error => {
                            console.error('Error fetching products:', error);
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                },
                selectProduct(product) {
                    this.selectedProduct = product;
                    this.newStock = product.quantity_in_stock;
                },
                addToCart(product) {
                    console.log(`${product.comic_name} - Volume ${product.volume_name} - ${this.users.name} of id ${this.users.id} clicked on Add to Cart!`);
                    
                    // Add to visual cart (new functionality)
                    this.cartItems.push({...product});
                    
                    // Original functionality
                    const url = `http://localhost:5002/composite/${this.users.id}/${product.Id}`;
                    fetch(url, {
                        method: 'GET',
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Received data:', data);
                        })
                        .catch(error => {
                            console.error('Error adding to cart:', error);
                            alert('Error adding to cart. Please try again.');
                        });
                },
                addToWaitlist(product) {
                    console.log(`${product.comic_name} - Volume ${product.volume_name} - ${this.users.name} id ${this.users.id} clicked on Join Waitlist!`);

                    const url = `http://localhost:5002/composite/${this.users.id}/${product.Id}`;
                    fetch(url, {
                        method: 'GET',
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Received data:', data);
                        })
                        .catch(error => {
                            console.error('Error adding to waitlist:', error);
                            alert('Error adding to waitlist. Please try again.');
                        });
                },
                updateStock() {
                    const updatedProduct = {
                        ...this.selectedProduct,
                        quantity_in_stock: this.newStock,
                    };

                    fetch('https://personal-dwnxuxog.outsystemscloud.com/InventoryAtomicMicroservice/rest/RESTAPI/UpdateStock', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updatedProduct),
                    })
                        .then(response => response.json())
                        .then(data => {
                            alert('Stock updated successfully!');
                            this.selectedProduct.quantity_in_stock = this.newStock;
                            this.selectedProduct = null;
                            this.newStock = 0;
                        })
                        .catch(error => {
                            console.error('Error updating stock:', error);
                            alert('Error updating stock. Please try again.');
                        });
                },
                
                // Cart methods (new)
                toggleCartModal() {
                    this.cartModal.toggle();
                },
                removeFromCart(index) {
                    this.cartItems.splice(index, 1);
                },
                checkout() {
                    alert('Checkout functionality would go here!');
                    this.cartItems = [];
                    this.cartModal.hide();
                }
            }
        });

        app.mount('#app');
    </script>
</body>
</html>