<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Stock</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7;
        }
        .product-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            justify-content: center;
        }
        .product-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 250px;
            text-align: center;
            cursor: pointer;
        }
        img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }
        h3 {
            font-size: 18px;
            margin-top: 10px;
        }
        p {
            font-size: 14px;
            color: #555;
            margin: 5px 0;
        }
        .form-container {
            max-width: 600px;
            margin: 50px auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        label {
            font-size: 14px;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
        }
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 8px;
            margin: 10px 0 20px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            width: 100%;
        }
        button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

    <!-- Products will be displayed here -->
    <div class="product-container" id="products-container"></div>

    <!-- Edit Stock Form -->
    <div class="form-container" id="stockForm">
        <h2>Edit Stock</h2>
        <form id="updateStockForm">
            <!-- Product details for name and stock only -->
            <label for="productName">Product Name</label>
            <input type="text" id="productName" name="productName" readonly />

            <label for="quantity_in_stock">Stock Quantity</label>
            <input type="number" id="quantity_in_stock" name="quantity_in_stock" required />

            <button type="submit">Update Stock</button>
        </form>
    </div>

    <script>
        let currentProduct = null; // Holds the currently selected product for editing

        // Function to fetch the product data from the API
        function fetchProducts() {
            const apiUrl = "https://personal-dwnxuxog.outsystemscloud.com/InventoryAtomicMicroservice/rest/RESTAPI/GetAllProducts";
            
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data && data.Products) {
                        displayProducts(data.Products);
                    } else {
                        alert('No products found in the API response');
                    }
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });
        }

        // Function to display products on the page
        function displayProducts(products) {
            const container = document.getElementById("products-container");
            container.innerHTML = "";

            products.forEach(product => {
                const productCard = document.createElement("div");
                productCard.classList.add("product-card");
                
                productCard.onclick = () => showProductDetails(product); // Set click event

                const productImage = document.createElement("img");
                productImage.src = "data:image/jpeg;base64," + product.image;

                const productName = document.createElement("h3");
                productName.textContent = product.comic_name + " - Volume " + product.volume_name;

                const productPrice = document.createElement("p");
                productPrice.textContent = "Price: $" + product.price_per_item.toFixed(2);

                const productStock = document.createElement("p");
                productStock.textContent = "Stock: " + product.quantity_in_stock;

                const productSold = document.createElement("p");
                productSold.textContent = "Quantity Sold: " + product.quantity_sold;

                // Append all elements to product card
                productCard.appendChild(productImage);
                productCard.appendChild(productName);
                productCard.appendChild(productPrice);
                productCard.appendChild(productStock);
                productCard.appendChild(productSold);
                container.appendChild(productCard);
            });
        }

        // Show product details in the form for editing stock
        function showProductDetails(product) {
            // Store the selected product in a variable to retain other details
            currentProduct = product;
            
            // Populate the form with product details (Only the name and stock)
            document.getElementById("productName").value = product.comic + " - Volume " + product.volume_name;
            document.getElementById("quantity_in_stock").value = product.quantity_in_stock;
            
            // Set the form submit handler
            document.getElementById("updateStockForm").onsubmit = (event) => {
                event.preventDefault();
                updateStock();
            };
        }

        // Update stock via PUT request
        function updateStock() {
            const stockQuantity = document.getElementById("quantity_in_stock").value;

            const requestData = {
                Id: currentProduct.Id, // Use the current product's ID
                quantity_in_stock: parseInt(stockQuantity) // Update only the stock
            };

            const apiUrl = "https://personal-dwnxuxog.outsystemscloud.com/InventoryAtomicMicroservice/rest/RESTAPI/UpdateStock";

            fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                // Handle the response
                if (data.Result && data.Result.Success) {
                    alert('Stock updated successfully');
                    fetchProducts(); // Refresh the product list
                } else {
                    alert('Failed to update stock');
                }
            })
            .catch(error => {
                console.error("Error updating stock:", error);
            });
        }

        // Fetch and display products when the page loads
        window.onload = function () {
            fetchProducts();
        };
    </script>
</body>
</html>
